<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>blace.ai: Model Wizard Creation</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">blace.ai
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('model_wizard_creation.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Model Wizard Creation</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="wizard_creation_hook"></a>
SYNOPSIS</h1>
<p><b>model-wizard</b> [<b>-h</b> | <b>&ndash;help</b>] [<b>-j</b> | <b>&ndash;json</b>] json-file [<b>-tm</b> | <b>&ndash;torchscript-model</b>] model-file [<b>-to</b> | <b>&ndash;onnx-model</b>] model-file [<b>-o</b> | <b>&ndash;output-folder</b>] output-folder [<b>-a</b> | <b>&ndash;activate</b>] [<b>-d</b> | <b>&ndash;deactivate</b>] [<b>-k</b> | <b>&ndash;key</b>] license-key</p>
<p>The executable can be found under tools/ on Linux and Windows and under BlaceAI.app/Contents/MacOS/ on MacOS.</p>
<h2><a class="anchor" id="autotoc_md21"></a>
DESCRIPTION</h2>
<p>The model wizard can be used to make existing Torchscript and ONNX models compatible with the blace.ai framework by tying it to a standardized description file (.json). This .json file describes the models in- and output and sets some arguments. For a given .json and Torchscript / ONNX file(s) the model wizard will output the .blacemodel and .h file as well as the .bin model payload (one per Torchscript / ONNX).</p>
<p>Note, that the model wizard does not run the provided model to check if all inputs / outputs are specified. Therefore a faulty .json might only be detected when the model is inferenced as part of a c++ executable built with blace.ai.</p>
<h2><a class="anchor" id="autotoc_md22"></a>
Arguments</h2>
<p><b>-j, &ndash;json</b> <br  />
 The model meta / descriptor .json file. Must match the schema described at the bottom of the page.</p>
<p><b>-tm, &ndash;torchscript-model</b> <br  />
 The torchscript file.</p>
<p><b>-om, &ndash;onnx-model</b> <br  />
 The onnx file.</p>
<p><b>-o, &ndash;output-folder</b> <br  />
 Where to store the final artifacts.</p>
<p><b>-a, &ndash;activate</b> Activate a license. Needs -k,&ndash;key.</p>
<p><b>-d, &ndash;deactivate</b> Deactivates the current license so it can be used on another device.</p>
<h1><a class="anchor" id="autotoc_md23"></a>
Prerequisites</h1>
<p>The models have a fixed number of input and output tensors and those tensors have a fixed number of dimensions. If you pass in both a torchscript and a onnx model, they must have the same inputs and outputs and are expected to produce the same results for a fixed input.</p>
<h1><a class="anchor" id="autotoc_md24"></a>
Examples</h1>
<p>We provide a sample .json and Torchscript file in the samples/model-wizard folder. Invoke the Model Wizard with <br  />
 <code>.\model_wizard --torchscript-model /samples/model-wizard/depth_anything_v2.pt --onnx-model /samples/model-wizard/depth_anything_v2.onnx --json /samples/model-wizard/depth_anything_v2.json --output-folder out</code>.</p>
<p>This will create a <b>depth_anything_v2.h</b>, <b>depth_anything_v2.blacemodel</b> and two .bin files in the folder <b>out</b>. Those files can then be used as drop-in replacement for the demo project contained in the SDK (depth estimation on butterfly image).</p>
<h1><a class="anchor" id="autotoc_md25"></a>
Model Descriptor</h1>
<p>The provided .json makes sure the framework can interpret all models in- and outputs.</p>
<h2><a class="anchor" id="autotoc_md26"></a>
Input Types</h2>
<p>Please check the example .json files to see how different inputs can be constructed. </p>
<h3><a class="anchor" id="autotoc_md27"></a>
MetaTensor</h3>
<p>A tensor always has these properties set:</p><ul>
<li><b>datatype</b>: The bitdepth / datatype of the tensor, e.g. INT_32 or FLOAT_32</li>
<li><b>normalization</b>: The value range of the contained data, e.g. ZERO_TO_ONE.</li>
<li><b>order</b>: The channel order, e.g. BCHW (standard image format)</li>
<li><b>color_format</b>: The color format of the C channel (if present), e.g. RGB.</li>
</ul>
<h3><a class="anchor" id="autotoc_md28"></a>
Float / Int / Bool</h3>
<p>For simple types you always have to provide a default value. This default value will be overriden by whatever input you pass to the model. If you have an entry </p><div class="fragment"><div class="line">{</div>
<div class="line">  &quot;name&quot;: &quot;float_input&quot;,</div>
<div class="line">  &quot;content&quot;: {</div>
<div class="line">    &quot;floatEntry&quot;: 15.2</div>
<div class="line">  },</div>
<div class="line">  &quot;inputSizes&quot;: []</div>
<div class="line">}</div>
</div><!-- fragment --><p> the value passed to the model will always be what you constructed with the <a class="el" href="classblace_1_1ops_1_1FromFloatOp.html">blace::ops::FromFloatOp()</a>.</p>
<h2><a class="anchor" id="autotoc_md29"></a>
Input Sizes</h2>
<p>Additionally, each input holds an array of ModelInputSize objects, describing each dimension of an input.</p><ul>
<li><b>modulo_by</b>: Dimension size needs to be divisable by this value.</li>
<li><b>min</b>: Minimum dimension size.</li>
<li><b>max</b>: Maximum dimension size.</li>
</ul>
<p>E.g. a model taking a BCHW image with 3 channels and the width and height dimension being divisable by 32 might have this .json entry for the input tensor </p><div class="fragment"><div class="line">&quot;inputSizes&quot;: [</div>
<div class="line">        {</div>
<div class="line">          &quot;modulo_by&quot;: 1,</div>
<div class="line">          &quot;min&quot;: 1,</div>
<div class="line">          &quot;max&quot;: 64</div>
<div class="line">        },</div>
<div class="line">        {</div>
<div class="line">          &quot;modulo_by&quot;: 1,</div>
<div class="line">          &quot;min&quot;: 3,</div>
<div class="line">          &quot;max&quot;: 3</div>
<div class="line">        },</div>
<div class="line">        {</div>
<div class="line">          &quot;modulo_by&quot;: 32,</div>
<div class="line">          &quot;min&quot;: 32,</div>
<div class="line">          &quot;max&quot;: 8196</div>
<div class="line">        },</div>
<div class="line">        {</div>
<div class="line">          &quot;modulo_by&quot;: 32,</div>
<div class="line">          &quot;min&quot;: 32,</div>
<div class="line">          &quot;max&quot;: 8196</div>
<div class="line">        }</div>
<div class="line">      ]</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md30"></a>
Output Sizes</h2>
<p>Last but not least the .json must specify how the output dimensions relate to the input dimensions by containing an array of ModelOutputSize for every output, with these properties:</p><ul>
<li><b>output_which_input</b>: Which input tensor to check. <br  />
</li>
<li><b>output_which_index</b>: Dimension index of the choosen model input. <br  />
</li>
<li><b>output_fixed_size</b>: Output is always a fixed size. <br  />
</li>
<li><b>output_ignore</b>: This dimension cannot be deduced from the input. <br  />
</li>
<li><b>output_multiplier_num</b> / <b>output_multiplier_denom</b>: Specifies the ratio of the output dimension size to the input dimension size. <br  />
</li>
</ul>
<p>E.g. an image super resolution model (4x), taking a RGB and BCHW tensor might have this entry: </p><div class="fragment"><div class="line">&quot;inputSizes&quot;: [</div>
<div class="line">        {</div>
<div class="line">          &quot;output_which_input&quot;: 0, # referring the first (and only) input tensor</div>
<div class="line">          &quot;output_which_index&quot;: 0, # referring the first dimension (B)</div>
<div class="line">        },</div>
<div class="line">        {</div>
<div class="line">          &quot;output_fixed_size&quot;: 3, # C channel will always have size of 3</div>
<div class="line">        },</div>
<div class="line">        {</div>
<div class="line">          &quot;output_which_input&quot;: 0, # referring the first (and only) input tensor</div>
<div class="line">          &quot;output_which_index&quot;: 2, # referring the third dimension (H)</div>
<div class="line">          &quot;output_multiplier_num&quot;: 4, # H channel will be 4 times as big as input</div>
<div class="line">          &quot;output_multiplier_denom&quot;: 1</div>
<div class="line">        },</div>
<div class="line">        {</div>
<div class="line">          &quot;output_which_input&quot;: 0, # referring the first (and only) input tensor</div>
<div class="line">          &quot;output_which_index&quot;: 3, # referring the fourth dimension (W)</div>
<div class="line">          &quot;output_multiplier_num&quot;: 4, # W channel will be 4 times as big as input</div>
<div class="line">          &quot;output_multiplier_denom&quot;: 1</div>
<div class="line">        }</div>
<div class="line">      ]</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md31"></a>
JSON Schema</h1>
<p>The provided .json file must match this schema. You can use it if you want to automatize schema validation, but for an easy start we recommend you to modify the provided sample .json: </p><pre class="fragment">{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "definitions": {
    "DataType": {
      "type": "string",
      "description": "The data type of a given tensor.",
      "enum": [
        "INT_32",
        "FLOAT_32",
        "BLACE_BYTE",
        "BLACE_BOOL",
        "FLOAT_32_16",
        "FLOAT_16",
        "SHORT",
        "INT_64",
        "FLOAT_64",
        "COMPLEX_64"
      ]
    },
    "Backend": {
      "type": "string",
      "description": "Backends enumeration.",
      "enum": [
        "TORCHSCRIPT_CUDA_FP32",
        "TORCHSCRIPT_CUDA_FP16",
        "TORCHSCRIPT_MPS_FP32",
        "ONNX_CUDA_FP32",
        "ONNX_CUDA_FP16",
        "ONNX_CPU_FP32",
        "TORCHSCRIPT_MPS_FP16",
        "TORCHSCRIPT_CPU_FP32",
        "ONNX_DML_FP32",
        "ONNX_DML_FP16",
        "TORCHSCRIPT_CPU_FP16"
      ]
    },
    "NormalizationEnum": {
      "type": "string",
      "description": "Possible value ranges of a tensor.",
      "enum": [
        "ZERO_TO_ONE",
        "MINUS_ONE_TO_ONE",
        "IMAGENET",
        "UNKNOWN_VALUE_RANGE",
        "ZERO_TO_255",
        "MINUS_0_5_TO_0_5",
        "ZERO_TO_32768"
      ]
    },
    "Normalization": {
      "type": "object",
      "description": "Normalization / value range object.",
      "properties": {
        "norm": {
          "$ref": "#/definitions/NormalizationEnum"
        },
        "allow_overflow": {
          "type": "boolean",
          "description": "Are values allowed to be outside of given range? E.g. can ZERO_TO_ONE tensor hold 1.1?"
        }
      }
    },
    "Order": {
      "type": "string",
      "description": "The ordering of the tensor. Use UNKNOWN_ORDER if order is not known.",
      "enum": [
        "BTCHW",
        "BCHW",
        "CHW",
        "HWC",
        "BHWC",
        "HW",
        "W",
        "WC",
        "C",
        "BC",
        "BWCH",
        "BHW",
        "BCH",
        "CH",
        "TBCHW",
        "BCWH",
        "BWHC",
        "NO_DIMS",
        "UNKNOWN_ORDER",
        "BOUNDING_BOX_WITH_DIMS",
        "THWC",
        "TCHW",
        "H",
        "BAUDIO_MONO_44100HZ",
        "BAUDIO_MONO_48000HZ"
      ]
    },
    "ColorFormat": {
      "type": "string",
      "description": "The color format of the tensor.",
      "enum": [
        "RGB",
        "R",
        "A",
        "ARGB",
        "ARBITRARY_CHANNELS",
        "BGRA",
        "BGR",
        "LAB",
        "AB",
        "L",
        "XYZ",
        "YCBCR",
        "Y",
        "BRG",
        "UV"
      ]
    },
    "MetaTensor": {
      "description": "An object describing layout and characteristics of a tensor.",
      "anyOf": [
        {
          "type": "object",
          "properties": {
            "data_type": {
              "$ref": "#/definitions/DataType"
            },
            "normalization": {
              "$ref": "#/definitions/Normalization"
            },
            "color_format": {
              "$ref": "#/definitions/ColorFormat"
            },
            "order": {
              "$ref": "#/definitions/Order"
            }
          }
        },
        {
          "type": "string",
          "enum": [
            "None"
          ]
        }
      ]
    },
    "Content": {
      "type": "object",
      "properties": {
        "metaTensor": {
          "$ref": "#/definitions/MetaTensor"
        }
      }
    },
    "ModelInputSize": {
      "type": "object",
      "description": "Object describing one dimension of a model input tensors shape.",
      "properties": {
        "modulo_by": {
          "type": "integer",
          "description": "Value the dimension has to be divisible by."
        },
        "min": {
          "type": "integer",
          "description": "Minimum size of this dimension."
        },
        "max": {
          "type": "integer",
          "description": "Maximum size of this dimension."
        }
      },
      "required": [
        "modulo_by",
        "min",
        "max"
      ]
    },
    "ModelOutputSize": {
      "type": "object",
      "description": "Object describing how a specific output dimension can be constructed from the models inputs.",
      "properties": {
        "output_which_input": {
          "description": "Nth model input.",
          "type": "integer"
        },
        "output_which_index": {
          "type": "integer",
          "description": "Dimension index of the nth model input."
        },
        "output_fixed_size": {
          "type": "integer",
          "description": "This dimension always has a fixed size (e.g. 3 for C channel in rgb images)."
        },
        "output_ignore": {
          "type": "boolean",
          "description": "The size of this dimension cannot be evaluated lazily and is not known at construction time."
        },
        "output_multiplier_num": {
          "type": "integer",
          "description": "Use this together with output_multiplier_denom to specify a factor of resizing. E.g. a 4x superresolution model would output a tensor with H and W dimension 4 times bigger than the input."
        },
        "output_multiplier_denom": {
          "type": "integer",
          "description": "See description of output_multiplier_num."
        }
      }
    },
    "Input": {
      "type": "object",
      "description": "Describes one (of potentially several) model inputs.",
      "properties": {
        "name": {
          "type": "string",
          "description": "Name of the input."
        },
        "content": {
          "$ref": "#/definitions/Content"
        },
        "inputSizes": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/ModelInputSize"
          }
        }
      }
    },
    "Output": {
      "type": "object",
      "description": "Describes one (of potentially several) model outputs.",
      "properties": {
        "name": {
          "type": "string",
          "description": "Name of the output."
        },
        "content": {
          "$ref": "#/definitions/Content"
        },
        "output_sizes": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/ModelOutputSize"
          }
        }
      }
    }
  },
  "type": "object",
  "properties": {
    "inputs": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/Input"
      }
    },
    "outputs": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/Output"
      }
    },
    "backends": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/Backend"
      }
    }
  },
  "required": [
    "backends",
    "inputs",
    "outputs"
  ]
}
</pre> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
